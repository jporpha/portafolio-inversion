<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Performance Display</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        canvas { margin-top: 40px; max-width: 100%; }
        label, input, button { margin-right: 10px; }
    </style>
</head>
<body>

<h1>Portfolio Evolution</h1>

<label for="portfolioId">Portfolio ID:</label>
<input type="number" id="portfolioId" value="1">
<label for="start">Start date:</label>
<input type="date" id="start" value="2022-02-15">
<label for="end">End Date:</label>
<input type="date" id="end" value="2022-05-31">
<button onclick="loadChartData()">Execute</button>

<canvas id="valueChart" height="100"></canvas>
<canvas id="weightsChart" height="100"></canvas>

<script>
    let valueChartInstance = null;
    let weightsChartInstance = null;

    async function loadChartData() {
        const id = document.getElementById("portfolioId").value;
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;

        const response = await fetch(`/api/v1/portfolio/calculations/${id}/evolution?start_date=${start}&end_date=${end}`);
        const result = await response.json();
        const data = result.evolution;

        const labels = data.map(d => d.date);
        const totalValues = data.map(d => d.totalValue);

        const assetNames = [...new Set(data.flatMap(d => d.assetsWeight.map(a => a.name)))];

        const datasets = assetNames.map(name => {
            return {
                label: name,
                data: data.map(d => {
                    const found = d.assetsWeight.find(a => a.name === name);
                    return found ? found.value * 100 : 0;
                }),
                fill: true
            };
        });

        if (valueChartInstance) valueChartInstance.destroy();
        if (weightsChartInstance) weightsChartInstance.destroy();

        valueChartInstance = new Chart(document.getElementById("valueChart"), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Portfolio Value (Vₜ)',
                    data: totalValues,
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0, 0, 255, 0.1)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Total Portfolio Value (Vₜ)' }
                }
            }
        });

        weightsChartInstance = new Chart(document.getElementById("weightsChart"), {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Asset Weights Over Time\n (wᵢₜ)' }
                },
                interaction: { mode: 'index', intersect: false },
                stacked: true,
                scales: {
                    y: {
                        ticks: { callback: value => value + '%' },
                        title: { display: true, text: 'Percentage (%)' }
                    }
                }
            }
        });
    }
</script>

</body>
</html>